const unified = require('unified')
const remark = require('remark')
const markdown = require('remark-parse')
const html = require('remark-html')
const highlight = require('remark-highlight.js')
const slug = require('remark-slug')
const externalLinks = require('remark-external-links')
const remarkAttr = require('remark-attr')
const report = require('vfile-reporter')
// * This is converted markdownfile to string
// const remark2rehype = require('remark-rehype')
// const html = require('rehype-stringify')
// * This is prevent XSS issue, but highlight cannot support
// const sanitize = require('rehype-sanitize')
// ! not working: Draw diagram plugins
// const graphviz = require('remark-graphviz')
// const mermaid = require('remark-mermaid')

function mdConvert(md, el) {
    return remark()
            .use(markdown)
            // convert content to string
            // .use(remark2rehype)
            .use(externalLinks, {target: false, rel: false})
            .use(slug)
            .use(remarkAttr)
            .use(highlight)
            .use(html)
            // .use(sanitize)
            .process(md, (err, file) => {
                // console.log(String(file))
                let jsEvent = /((javascript:)|(&#)).*?/ig
                let onEvent = /(on.{4,12}=([""].*?[""]|['].*?[']))/ig
                console.error(report(err || file))
                el.innerHTML = String(file).replace(jsEvent, '#').replace(onEvent, '')
            })
}

module.exports = mdConvert