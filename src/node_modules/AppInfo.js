const bel = require('bel')
const csjs = require('csjs-inject')
// widgets
const Graphic = require('Graphic')
const actions = require('actions')
// const md = require('markdown-it')({
//     html: false,
// 	xhtmlOut: true,
// 	typographer: true,
//     linkify: true,
//     typography: true,
//     langPrefix: 'language-',
//     })
//     .enable([ 'link' ])
//     .enable('image')
//     .use(require('markdown-it-highlightjs'), {
//         auto: true,
//         code: true
//     })
    // .use(require('markdown-it-anchor'), {
    //     level: 1,
    //     permalink: false,
    //     permalinkClass: 'header-anchor',
    //     permalinkSpace: true,
    //     permalinkSymbol: 'Â¶',
    //     permalinkBefore: true,
    // })

const mdConvert = require('mdConvert')
const mdTocConvert = require('mdTocConvert')
const report = require('vfile-reporter')

function AppInfo(styl, url, title, package, protocol) {
    const css = style
    // load first version form data
    let vers  = package.versions.latest
    const path  = `${url}/dist/${vers}`
    const version = package.versions.all.map( v => bel`<option>${v}</option>`)

    // switch image type
    if (package.logo.includes("svg")) {
        var img = Graphic(`${url}/${package.logo}`, css["intro-logo"])
    } else {
        var img = bel`<img class=${css["intro-logo"]} src="${url}/${package.logo}" alt=${package.title} />`
    }

    // icons
    let icon_info = Graphic('./src/node_modules/assets/svg/info.svg', css.icon)
    let icon_doc = Graphic('./src/node_modules/assets/svg/doc.svg', css.icon)
    let icon_settings = Graphic('./src/node_modules/assets/svg/settings.svg', css.icon)
    let icon_news = Graphic('./src/node_modules/assets/svg/news.svg', css.icon)
    let icon_about = Graphic('./src/node_modules/assets/svg/about.svg', css.icon)
    let icon_chat = Graphic('./src/node_modules/assets/svg/chat.svg', css.icon)
    let icon_supplyTree = Graphic('./src/node_modules/assets/svg/supply-tree.svg', css.icon)
    let icon_shrink = Graphic('./src/node_modules/assets/svg/double-arrow.svg', css.icon)
    
    // elements
    const shrinkAction = bel`<button class="${css.btn} ${css.shrink}">${icon_shrink}</button>`
    const content = bel`<div class=${css.content}></div>`
    const introHeader = bel`<section class=${css["intro-header"]}></section>`
    const markdown = bel`<div class=${css.markdown}></div>`
    const buttons = actions({styl, title, vers, url, package})

    // sidebar menu
    const nav = bel ` 
    <nav class=${css.nav}>
        <a href="#intro" class=${css.current} onclick=${()=>switchPageHandler('#intro')}>${icon_info} Introduction</a>
        <a href="#doc" onclick=${()=>switchPageHandler('#doc')}>${icon_doc} Documentation</a>
        <a href="#settings" onclick=${()=>switchPageHandler('#settings')}>${icon_settings} Settings</a>
        <a href="#news" onclick=${()=>switchPageHandler('#news')}>${icon_news} News</a>
        <a href="#about" onclick=${()=>switchPageHandler('#about')}>${icon_about} About</a>
        <a href="#chat" onclick=${()=>switchPageHandler('#chat')}>${icon_chat} Support Chat</a>
        <a href="#supplyTree" onclick=${()=>switchPageHandler('#supplyTree')}>${icon_supplyTree} Supply tree</a>
    </nav>`

    // versions selector
    const selectVersion = bel`
    <div class=${css.selector}>
        <label>Version: </label>    
        <select onchange=${() => selectorHandler(event)}>
            ${version}
        </select>
    </div>`

    selectVersion.children[1].value = package.versions.latest

    // get version
    function selectorHandler(event) {
           const x = event.target.value
           vers = x
           return loadIntroVers(x)
    }

    // load intro version
    async function loadIntroVers(x) {
        const currentPanel = document.querySelector(`.app_${title}`)
        const currentActions = currentPanel.querySelector(`.${buttons.classList[0]}`)
        const path = `${url}/dist/${x}/${package.intro}`
        const data = await fetch(path).then(res => res.text())
        // var result = md.render(data)
        
        currentActions.remove()
        introHeader.append( actions({title, vers, url, package}) )

        mdConvert().process(data, function (err, file) {
            // console.log(String(file))
            console.error(report(err || file))
            markdown.innerHTML = String(file)
        })
        
    }
    
    // display default page
    getInfo(package.intro, 'intro', loadPage)

    // collapse button
    shrinkAction.addEventListener('click', () => {
        const currentWindow = document.querySelector(`.app_${title}`)
        const container = currentWindow.querySelector(`.${css.container}`)
        container.classList.toggle(css.collapse)
    })

    const el = bel `
    <div class=${css.container}>
        <div class=${css.sidebar}>
            ${nav}
            ${shrinkAction}
        </div>
        ${content}
    </div>
    `
    return el

    // switch page
    function switchPageHandler(href) {
        // get all a tag name from nav
        const pages = nav.querySelectorAll('a')
        // switch current page
        pages.forEach(page => {
            if (page.getAttribute('href') === href) {
                page.classList.add(css.current)
                const target = href.split("#").slice(1).join('').toString()
                pageHandler(target)
            } else {
                page.classList.remove(css.current)
            }
        })
    }

    function pageHandler(i) {
        console.log(`${i} page loaded`);
        // clear content to add new contnet
        content.innerHTML = ''

        if (i === 'chat' ) {
            content.innerHTML = '<iframe src="https://gitter.im/wizardamigosinstitute/program/~embed" frameborder="0" allowfullscreen="allowfullscreen"></iframe>'
        } else if (i === 'about') {
            getInfo(package.about.info, i, loadPage)
        } else if (i === 'settings') {
        } else if (i === 'supplyTree') {
        } else {
            getInfo(package[i], i, loadPage)
        }
    }

    async function getInfo(file, page, done) {
        try {
            if (page === "intro") {
                var result = {
                    intro: await fetch(`${path}/${file}`).then(res => res.text()),
                    maintainer: await fetch(`${url}/${package.about.maintainer}`).then(res => res.json())
                }

            } else if (page === "doc" ) {
                if (vers === package.versions.latest) {
                    if ( package.doc.includes('http') ) {
                        var result = await fetch(package.doc).then(res => res.text())
                        // var data = `${url}/dist/${vers}/blob/v${vers}.md`
                        // var result = await fetch(data).then(res => res.text())
                    } else {
                        var data = `${url}/dist/${vers}/blob/v${vers}.md`
                        var result = await fetch(data).then(res => res.text())
                    }
                       
                } else {
                    data = `${url}/dist/${vers}/blob/v${vers}.md`
                    var result = await fetch(data).then(res => res.text())
                }

                
            } else if (page === "supplyTree") {
                var result = await fetch(`${path}/${file}`)
            } else {
                var result = await fetch(`${url}/${file}`).then(res => res.text())
            }
            
            return done(null, page, result)

        } catch (error) {
            done(error)
        }
    }

    function loadPage(err, page, data) {
        const currentWindow = document.querySelector(`.app_${title}`)
        const content = currentWindow.querySelector(`.${css.content}`)
        let article = bel`<article class=${css['app-info']}></article>`
        let removeFn = /on\w+=(["\'])[^\1]*?\1/ig
        if (err) return console.log(err)

        // page content start
        if (page === 'intro') {
            const { intro, maintainer } = data
            // var result = md.render(intro)

            mdConvert().process(intro, (err, file) => {
                // console.log(String(file))
                console.error(report(err || file))
                markdown.innerHTML = String(file)
            })
            
            // info 
            const info = bel`
            <div class=${css["intro-info"]}>
                ${img}
                <div class=${css["intro-content"]}>
                    <h4 class=${css["intro-title"]}>${package.title}</h4>
                    <a class=${css.link} href="${maintainer.url}" target="_blank">${maintainer.name}</a>
                </div>
            </div>`

            introHeader.innerHTML = ''
            introHeader.append(info, selectVersion, buttons)
            article.appendChild(introHeader)
            article.append(markdown)

        } else if ( page === "doc") {
            // var result = md.render(data)
            let docs = bel`<section class="${css.docs}"></section>`
            var aside = bel`<aside class=${css.toc}></aside>`
            var list = bel`<nav class=${css.list}></nav>`

            // markdown file convert
            mdConvert()
            .process(data, (err, file) => {
                // console.log('doc', String(file))
                console.error(report(err || file))
                markdown.innerHTML = file
            })
            
            // make toc list from markdown
            let nav
            mdTocConvert()
            .process(data, (err, file) => {
                // console.log('nav', String(file))
                console.error(report(err || file))
                return nav = String(file)
            })
            list.innerHTML = nav
            aside.append(list)

            docs.append(aside, markdown)
            article.append(docs)

        } 
        else {
            mdConvert()
            .process(data, (err, file) => {
                // console.log(page, String(file))
                console.error(report(err || file))
                let final = String(file).replace(removeFn, '')
                markdown.innerHTML = final
            })

            article.append(markdown)   
        }

        
        // if page includes below conditions, add hljs.css into head
        if (page === 'intro' || page === 'doc' || page === 'about') {
            const hljsStyle = bel `<link href="./src/node_modules/assets/css/hljs.css" rel='stylesheet' type='text/css'>`
            document.head.appendChild(hljsStyle)
        }
        
        content.innerHTML = ''
        content.appendChild(article)

        let toc = document.querySelector(`.${css.toc}`)
        if (toc) {
            // first get toc all ul elements
            let lists = [...list.querySelectorAll('ul')]
            // add class to all ul elements
            lists.map( ul =>  { 
                ul.classList.add(css["toc-collapse"]) 
                
                let li = [...ul.children]

                li.forEach( (el, i, arr) => collapaseHandler(el, i, arr) )
            } )
            
            function collapaseHandler(el, i, arr) {
                let plus = bel`<img src="./src/node_modules/assets/svg/plus.svg" class=${css.icon}>`
                let minus = bel`<img src="./src/node_modules/assets/svg/minus.svg" class=${css.icon}>`
                // let minus = Graphic('./src/node_modules/assets/svg/minus.svg', css.icon) 

                let items = [...el.children]
                items.map( item => {
                    if (item.tageName === 'a') return
                    el.append(plus)
                })
                

                el.addEventListener('click', (e) => {

                    plus.remove()
                    el.append(minus)

                    // remove all active
                    removeClass(arr, css.active)

                    // find nextElementSibling and remove active status
                    if (e.target.parentNode.nextElementSibling) {
                        let currentToc = [...e.target.parentNode.nextElementSibling.children]
                        currentToc.map( tocList => tocList.classList.remove(css.active) )
                    }
                    
                    // add active status
                    addClass(el, css.active)
                })
            }

            function removeClass(arr, klass) {
                arr.forEach( i => { 
                    i.classList.remove(klass)
                })
            }

            function addClass(el, klass) {
                el.classList.add(klass)
            }
        }
        
        

    }

}


const style = csjs `
.container {
    display: grid;
    grid-template-rows: 1fr;
    grid-template-columns: 150px auto;
    height: 100%;
}
.sidebar {
    display: grid;
    grid-template-columns: 150px;
    grid-template-rows: auto 30px;
    grid-template-areas: 
    'nav'
    'shrink';
    background-color: var(--appInfoSidebarBgColor);
}
.collapse {
    grid-template-columns: 38px auto;
}
.collapse .sidebar {
    grid-template-columns: 38px;
}
.nav {
    grid-area: nav;
    overflow: hidden;
    overflow-y: auto;
    max-height: calc( 75vh - 30px - 29px );
}
.nav a {
    display: grid;
    grid-template-rows: 44px;
    grid-template-columns: 38px auto;
    align-items: center;
    font-size: var(--appInfoSidebarFontSize);
    color: var(--appInfoSidebarColor);
    text-decoration: none;
}
.nav a:hover svg [class="b"], .nav a:hover svg [class="c"], .nav a:hover svg [class="a"]
{
    stroke: var(--linkHoverColor);
}
/* current page info */
.current {
    background-color: var(--appInfoSidebarNavCurrentBgColor);
}
.nav .icon {
    width: 18px;
    justify-self: center;
}
.shrink {
    grid-area: shrink;
    background-color: var(--appInfoSidebarShrinkBgColor);
    border-radius: 0;
    padding: 5px 0;
    margin: 0;
}
.shrink:hover {
    background-color: var(--appInfoSidebarShrinkHoverBgColor);
}
.shrink .icon {
    display: grid;
    grid-template-columns: auto 20px;
}
.shrink .icon svg {
    transform: rotate(-180deg);
    grid-column-start: 2;
    width: 16px;
}
.collapse .shrink .icon {
    grid-template-columns: auto;
    justify-items: center;
}
.collapse .shrink .icon svg {
    transform: rotate(0deg);
    grid-column-start: 1;
    grid-column-end: 2;
}
/* App info */
.content {
    height: calc( var(--contentHeight) );
    overflow: hidden;
    overflow-y: auto;
}
.app-info {
    position: relative;
    padding: 0 20px;
}
.download {

}
.remove {

}
.launch {

}
.pin {

}
.content table {
    display: block;
    width: 100%;
    overflow: auto;
}

.content tr {
    background-color: #fff;
    border-top: 1px solid #c6cbd1;
}

.content table td,
.content table th {
    padding: 6px 13px;
    border: 1px solid #dfe2e5;
}
.content table tr:nth-child(2n) {
    background-color: #f6f8fa;
}
.intro-header {
    display: grid;
    grid-template-rows: 1fr auto;
    grid-template-columns: auto 163px;
    grid-template-areas: "info selector"
                         "actions actions";
    padding-top: 20px;
}
.intro-info {
    grid-area: info;
    display: grid;
    grid-template: auto / 48px auto;
    grid-gap: 0px 10px;
}
.intro-content {
    grid-row-start: 1;
    grid-column-start: 2;
    padding-top: 5px;
}
.intro-title {
    margin: 0;
    font-weight: normal;
    font-size: var(--appInfoIntroTitleFontSize);
    align-self: center;
}
.intro-logo {

}
.link {
    font-size: var(--appInfoLinkFontSize);
    text-decoration: none;
}
.selector {
    grid-area: selector;
    justify-self: right;
    align-self: start;
}
.selector label {
    font-size: var(--appInfoSelectorFontSize);
}
select {

}
.markdown {
    line-height: 1.5;
}
/* Title defines */
.markdown h1 {
    font-size: 2.8rem;
}
.markdonw h2 {
    font-size: 2rem
}
.markdonw h3 {
    font-size: 1.8rem
}
.markdonw h4 {
    font-size: 1.6rem
}
.markdonw h5 {
    font-size: 1.4rem
}
.markdonw h6 {
    font-size: 1.2rem
}
.docs {
    display: grid;
    grid-template-columns: auto 150px;
    grid-gap: 10px;
}
.docs .markdown {
    grid-row: 1;
    grid-column: 1;
}
.toc {
    position: relative;
    grid-row: 1;
    grid-column: 2;
    height: 100%;
}
.toc a {
    text-decoration: none;
}
.toc a:hover {
    text-decoration: underline;
}
.list {
    position: fixed;
    right: 0px;
    top: 35px;
    padding-left: 25px;
    width: 180px;
    height: calc(100% - 40px);
    overflow: hidden;
    overflow-y: auto;
}
.toc-collapse {
    padding: 0;
    margin: 0 0 0 12px;
}
.toc-collapse ul {
    display: none;
}
.toc-collapse li {
    position: relative;
    list-style-type: none;
    font-size: 1.2rem;
    line-height: 1.2;
}
.toc-collapse p {
    margin: 10px 0 10px 0;
}
.toc-collapse .icon {
    position: absolute;
    left: -16px;
    top: 1px;
    width: 12px;
}
.toc-collapse a:hover, .toc-collapse .active > .toc-collapse a:hover,
.toc-collapse .active > .toc-collapse .active > .toc-collapse a:hover,
.toc-collapse .active > .toc-collapse .active .toc-collapse > .active > .toc-collapse a:hover,
.toc-collapse .active > .toc-collapse .active > .toc-collapse .active > .toc-collapse .active > .toc-collapse a:hover
{
    color: var(--linkHoverColor);
}

.toc-collapse li > .toc-collapse li > .toc-collapse li > .toc-collapse li a
{
    line-height: 1.8;
}
.toc-collapse a, .toc-collapse a:hover {
    text-decoration: none;
}
.toc-collapse .active a, 
.toc-collapse .active > .toc-collapse .active a,
.toc-collapse .active > .toc-collapse .active > .toc-collapse .active a,
.toc-collapse .active > .toc-collapse .active > .toc-collapse .active > .toc-collapse .active a
{
    font-weight: bold;
    color: #000;
}
.toc-collapse .active > .toc-collapse a,
.toc-collapse .active > .toc-collapse .active > .toc-collapse a,
.toc-collapse .active > .toc-collapse .active > .toc-collapse .active > .toc-collapse a,
.toc-collapse .active > .toc-collapse .active > .toc-collapse .active > .toc-collapse .active > .toc-collapse a
{
    font-weight: normal;
    color: #707070;
}
.toc-collapse .active > .toc-collapse {
    display: block;
}
@media screen and (max-width: 1024px) {
    .content {
        height: calc( 100vh - 29px - 4px);
    }
}
`

module.exports = AppInfo